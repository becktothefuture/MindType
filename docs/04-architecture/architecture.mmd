%%{init: {'theme': 'base', 'themeVariables': {'primaryColor': '#e3f2fd', 'primaryTextColor': '#0d47a1', 'primaryBorderColor': '#1976d2', 'lineColor': '#424242', 'secondaryColor': '#f3e5f5', 'tertiaryColor': '#e8f5e8', 'background': '#fafafa', 'mainBkg': '#ffffff', 'secondBkg': '#f5f5f5', 'tertiaryBkg': '#eeeeee'}}}%%
%% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
%% ğŸ§  MINDTYPE SYSTEM ARCHITECTURE (v0.5) - RUST-FIRST SOURCE OF TRUTH
%% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
%% 
%% PURPOSE: Complete visual map of Mind::Type's Rust-first text correction pipeline
%% SCOPE: All components from keystroke capture to text application
%% UPDATED: September 2025 - Reflects Rust-first architecture per ADR-0005
%% 
%% LEGEND & VISUAL HIERARCHY:
%% ğŸŸ¢ Implemented or Design Complete  ğŸŸ¡ In Progress  ğŸ”´ Not Yet Built
%% ===> Critical Path (Bold)  --> Standard Connection  -.-> Feedback Loop
%% ğŸ“¥ Input Points  ğŸ“¤ Output Points  âš¡ Processing  ğŸ¯ Decision Gates
%% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

graph LR
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% ğŸ¯ CRITICAL PATH OVERVIEW (Quick Reference)
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% 
    %% INPUT: ğŸ“ User Types â†’ ğŸ“¡ Event Capture (Platform UI) â†’ ğŸš€ Correction Request (FFI/WASM)
    %%    â†“
    %% PROCESSING (Rust Core): âš¡ Correction Engine â†’ ğŸ§¹ Noise/Grammar/Context/Tone Workers â†’ ğŸ”€ Conflict Resolution
    %%    â†“  
    %% VALIDATION (Rust Core): âš–ï¸ Confidence Gate â†’ ğŸ“Š Active Region â†’ âš›ï¸ Correction List
    %%    â†“
    %% OUTPUT: â†©ï¸ Correction Response (FFI/WASM) â†’ ğŸ¬ Visual Application (Platform UI) â†’ ğŸ“ Updated Text
    %% 
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    %% ========================================
    %% TEXT INPUT/OUTPUT LOOP (Critical Flow)
    %% ========================================
    subgraph TEXT_LOOP ["ğŸ“ **TEXT INPUT/OUTPUT LOOP**<br/>Where text gets read and written<br/>ğŸ“š Docs: PRD.md (REQ-IME-CARETSAFE)"]
        direction TB
        
        subgraph TEXT_INPUT ["**ğŸ“¥ TEXT READING**<br/>ğŸ¯ User Input Capture"]
            TEXT_FIELD[("**â‘  ğŸ“ TEXT FIELD - INPUT**<br/>ğŸ”¤ Example: 'helloo thr weathfr'<br/>ğŸ“ Caret at position 17<br/>ğŸ‘¤ User actively typing<br/>ğŸš€ **ENTRY POINT**")]
            PLATFORM_UI_INPUT["**â‘¡ ğŸ“¡ Platform UI (JS/Swift)**<br/>ğŸ”§ Captures text, caret, timestamp<br/>âš¡ Every keystroke or pause"]
            RUST_REQUEST["**â‘¢ ğŸš€ Correction Request**<br/>ğŸ“¨ FFI/WASM call to Rust Core<br/>ğŸ¯ Creates CorrectionRequest struct<br/>ğŸŒŠ Stream begins"]
        end
        
        subgraph TEXT_OUTPUT ["**ğŸ“¤ TEXT WRITING**<br/>âœ¨ Corrected Output"]
            RUST_RESPONSE["**â‘« âœ… Correction Response**<br/>ğŸ¯ High-confidence corrections from Rust<br/>ğŸ“‹ List of Correction objects"]
            PLATFORM_UI_APPLY["**â‘¬ âš›ï¸ Visual Application (JS/Swift)**<br/>ğŸ”§ replaceRange() + Dot Matrix Wave<br/>ğŸ”¤ UTF-16 safe<br/>ğŸ“ Caret preserved"]
            UPDATED_FIELD[("**â‘­ ğŸ“ UPDATED FIELD - OUTPUT**<br/>âœ¨ Result: 'Hello, the weather'<br/>ğŸ“ Caret position preserved<br/>ğŸ‘¤ User sees corrections<br/>ğŸ‰ **EXIT POINT**")]
        end
        
        TEXT_FIELD ==>|"**ğŸš€ KEYSTROKE**<br/>âš¡ Immediate capture"| PLATFORM_UI_INPUT
        PLATFORM_UI_INPUT ==>|"**ğŸ“Š CREATE REQUEST**"| RUST_REQUEST
        RUST_RESPONSE ==>|"**âœ… APPLY CORRECTIONS**"| PLATFORM_UI_APPLY
        PLATFORM_UI_APPLY ==>|"**âš›ï¸ ATOMIC UPDATE**<br/>ğŸ“ Caret preserved"| UPDATED_FIELD
        UPDATED_FIELD -.->|"**ğŸ”„ CONTINUOUS LOOP**<br/>â™¾ï¸ Typing cycle"| TEXT_FIELD
    end
    
    %% ========================================
    %% PLATFORM UI LAYER
    %% ========================================
    subgraph PLATFORM ["ğŸŒ **PLATFORM UI LAYER** (JS/Swift)<br/>ğŸ“š Docs: adr/0005-rust-first-orchestrator.md"]
        direction TB
        WEB["**ğŸŸ¢ Web Platform**<br/>web-demo/src/App.tsx<br/>React + TypeScript + Vite<br/>Calls WASM module"]
        MAC["**ğŸŸ¡ macOS Platform**<br/>Swift + AX API + FFI<br/>NSStatusItem menu bar app<br/>Calls C FFI Bridge"]
    end
    
    %% ========================================
    %% RUST CORE ENGINE
    %% ========================================
    subgraph RUST_CORE ["âš¡ **RUST CORE ENGINE**<br/>ğŸ“š Docs: architecture/rust-first-design.md, adr/0005"]
        direction TB
        
        subgraph FFI_WASM ["**FFI / WASM BRIDGE**<br/>crates/core-rs/src/ffi.rs<br/>crates/core-rs/src/wasm_bindings.rs"]
            FFI_C["**ğŸŸ¢ C FFI Bridge**<br/>For macOS/iOS"]
            WASM_JS["**ğŸŸ¢ WASM Bridge**<br/>For Web"]
        end

        ENGINE["**ğŸŸ¢ Correction Engine**<br/>crates/core-rs/src/engine.rs<br/>Orchestrates all workers"]
        
        subgraph WORKERS ["**CORRECTION WORKERS**"]
            NOISE_WORKER["**ğŸŸ¢ Noise Worker**<br/>Typos, Spacing"]
            GRAMMAR_WORKER["**ğŸŸ¢ Grammar Worker**<br/>Punctuation, Case"]
            CONTEXT_WORKER["**ğŸŸ¡ Context Worker**<br/>Coherence (LM)"]
            TONE_WORKER["**ğŸ”´ Tone Worker**<br/>Formality"]
        end
        
        CONFLICT_RESOLVER["**ğŸŸ¢ Conflict Resolver**<br/>crates/core-rs/src/conflict_resolver.rs<br/>Merges worker outputs"]
    end
    
    %% ========================================
    %% VALIDATION & STATE MANAGEMENT (RUST)
    %% ========================================
    subgraph VALIDATION ["ğŸ§© **VALIDATION & STATE (RUST)**<br/>ğŸ“š Docs: adr/0002-caret-safe-diff.md"]
        direction TB
        
        CONFIDENCE["**ğŸŸ¢ Confidence Scorer**<br/>crates/core-rs/src/confidence.rs<br/>4D mathematical scoring"]
        ACTIVE_REGION["**ğŸŸ¢ Active Region Manager**<br/>crates/core-rs/src/active_region.rs<br/>20-word safe zone, rollback"]
        DIFF_GATE["**ğŸŸ¢ Diff/Merge Gate**<br/>crates/core-rs/src/diff.rs<br/>Caret-safe atomic updates"]
    end
    
    %% ========================================
    %% PRIMARY DATA FLOW CONNECTIONS
    %% ========================================
    
    RUST_REQUEST ===>|"**To Rust Core**"| FFI_WASM
    FFI_WASM --> ENGINE
    
    ENGINE --> WORKERS
    WORKERS --> CONFLICT_RESOLVER
    CONFLICT_RESOLVER --> CONFIDENCE
    CONFIDENCE --> ACTIVE_REGION
    ACTIVE_REGION --> DIFF_GATE
    
    DIFF_GATE ===>|"**From Rust Core**"| RUST_RESPONSE

    %% Internal Connections
    PLATFORM_UI_INPUT --> WEB
    PLATFORM_UI_INPUT --> MAC

    %% Link back to platform
    WEB --> FFI_WASM
    MAC --> FFI_WASM
    
    %% Feedback Loops
    UPDATED_FIELD -.->|"**Caret Moved**<br/>New typing event"| PLATFORM_UI_INPUT
    
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% ğŸ¨ VISUAL STYLING & GESTALT PRINCIPLES
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    %% â•â•â• IMPLEMENTATION STATUS COLORS (Primary Visual Hierarchy) â•â•â•
    classDef ready fill:#c8e6c9,stroke:#2e7d32,stroke-width:3px,color:#1b5e20
    classDef partial fill:#fff3c4,stroke:#f57c00,stroke-width:3px,color:#e65100
    classDef missing fill:#ffcdd2,stroke:#c62828,stroke-width:3px,color:#b71c1c
    
    %% â•â•â• ARCHITECTURAL LAYER COLORS (Gestalt Grouping) â•â•â•
    classDef criticalFlow fill:#e3f2fd,stroke:#0d47a1,stroke-width:4px,color:#0d47a1
    classDef platformLayer fill:#e1f5fe,stroke:#0277bd,stroke-width:2px,color:#01579b
    classDef rustCore fill:#f3e5f5,stroke:#7b1fa2,stroke-width:3px,color:#4a148c
    classDef validationSafety fill:#fff8e1,stroke:#ff8f00,stroke-width:2px,color:#ff6f00
    
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% ğŸ¨ GESTALT VISUAL HIERARCHY APPLICATION
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    class TEXT_LOOP,TEXT_INPUT,TEXT_OUTPUT criticalFlow
    class PLATFORM,WEB,MAC platformLayer
    class RUST_CORE,FFI_WASM,ENGINE,WORKERS,CONFLICT_RESOLVER rustCore
    class VALIDATION,CONFIDENCE,ACTIVE_REGION,DIFF_GATE validationSafety
    
    %% Status Application
    class WEB, ENGINE, FFI_WASM, NOISE_WORKER, GRAMMAR_WORKER, CONFLICT_RESOLVER, CONFIDENCE, ACTIVE_REGION, DIFF_GATE ready
    class MAC, CONTEXT_WORKER partial
    class TONE_WORKER missing
    
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% ğŸ“š DOCUMENTATION REFERENCE MAP
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% 
    %% CORE ARCHITECTURE:
    %% â€¢ adr/0005-rust-first-orchestrator.md - The authoritative decision for this design
    %% â€¢ architecture/rust-first-design.md - Detailed explanation of components
    %% â€¢ guides/reference/rust-core-api.md - The exact API contract
    %% 
    %% KEY PRINCIPLES:
    %% â€¢ adr/0002-caret-safe-diff.md - The core safety guarantee
    %% â€¢ PRD.md - High-level product requirements
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
