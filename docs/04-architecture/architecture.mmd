%%{init: {'theme': 'base', 'themeVariables': {'primaryColor': '#e3f2fd', 'primaryTextColor': '#0d47a1', 'primaryBorderColor': '#1976d2', 'lineColor': '#424242', 'secondaryColor': '#f3e5f5', 'tertiaryColor': '#e8f5e8', 'background': '#fafafa', 'mainBkg': '#ffffff', 'secondBkg': '#f5f5f5', 'tertiaryBkg': '#eeeeee'}}}%%
%% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
%% ğŸ§  MINDTYPE SYSTEM ARCHITECTURE (v0.4) - SOURCE OF TRUTH
%% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
%% 
%% PURPOSE: Complete visual map of MindType's text correction pipeline
%% SCOPE: All components from keystroke capture to text application
%% UPDATED: September 2025 - Reflects current implementation state
%% 
%% LEGEND & VISUAL HIERARCHY:
%% ğŸŸ¢ Ready (Fully Implemented)  ğŸŸ¡ Partial (Needs Polish)  ğŸ”´ Missing (Not Yet Built)
%% ğŸ”„ Dual Architecture: TS (Current) + Rust (Target)  ğŸš¨ Bug/Violation Flagged
%% 
%% FLOW EMPHASIS:
%% ===> Critical Path (Bold)  --> Standard Connection  -.-> Feedback Loop
%% ğŸ“¥ Input Points  ğŸ“¤ Output Points  âš¡ Processing  ğŸ¯ Decision Gates
%% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

graph LR
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% ğŸ¯ CRITICAL PATH OVERVIEW (Quick Reference)
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% 
    %% INPUT: ğŸ“ User Types â†’ ğŸ“¡ Event Capture â†’ ğŸš€ Pipeline Start
    %%    â†“
    %% PROCESSING: ğŸ§¹ Noise â†’ ğŸ“š Context (LM) â†’ ğŸ¨ Tone â†’ ğŸ”€ Conflict Resolution
    %%    â†“  
    %% VALIDATION: âš–ï¸ Confidence Gate â†’ ğŸ¤– Staging â†’ ğŸ“Š Active Region â†’ âš›ï¸ Diff/Merge
    %%    â†“
    %% OUTPUT: ğŸ¬ UI Feedback â†’ âš›ï¸ Atomic Update â†’ ğŸ“ Updated Text â†’ ğŸ‘¤ User Sees Result
    %% 
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    %% ========================================
    %% TEXT INPUT/OUTPUT LOOP (Critical Flow)
    %% ========================================
    subgraph TEXT_LOOP ["ğŸ“ **TEXT INPUT/OUTPUT LOOP**<br/>Where text gets read and written<br/>ğŸ“š Docs: PRD.md (REQ-IME-CARETSAFE, REQ-TIDY-SWEEP)"]
        direction TB
        
        subgraph TEXT_INPUT ["**ğŸ“¥ TEXT READING** (1-3)<br/>ğŸ¯ User Input Capture"]
            TEXT_FIELD[("**â‘  ğŸ“ TEXT FIELD - INPUT**<br/>ğŸ”¤ Example: 'helloo thr weathfr'<br/>ğŸ“ Caret at position 17<br/>ğŸ‘¤ User actively typing<br/>ğŸš€ **ENTRY POINT**")]
            DOM_EVENTS["**â‘¡ ğŸ“¡ Event Capture**<br/>ğŸ”§ handleTextChange()<br/>ğŸ“Š Extract: text, caret, timestamp<br/>âš¡ Every keystroke captured<br/>ğŸ”„ Real-time processing"]
            PIPELINE_INGEST["**â‘¢ ğŸš€ Pipeline Start**<br/>ğŸ“¨ pipeline.ingest()<br/>ğŸ¯ Creates TypingEvent<br/>âš¡ Triggers processing<br/>ğŸŒŠ Stream begins"]
        end
        
        subgraph TEXT_OUTPUT ["**ğŸ“¤ TEXT WRITING** (12-14)<br/>âœ¨ Corrected Output"]
            CORRECTIONS_READY["**â‘« âœ… Corrections Ready**<br/>ğŸ¯ High-confidence edits<br/>ğŸšª Passed quality gates<br/>ğŸ“‹ Ready to apply<br/>âš¡ Final validation"]
            REPLACE_RANGE["**â‘¬ âš›ï¸ Atomic Update**<br/>ğŸ”§ replaceRange()<br/>ğŸ”¤ UTF-16 safe<br/>ğŸ“ Caret preserved<br/>ğŸ›¡ï¸ Exception-safe"]
            UPDATED_FIELD[("**â‘­ ğŸ“ UPDATED FIELD - OUTPUT**<br/>âœ¨ Result: 'Hello, the weather'<br/>ğŸ“ Caret position preserved<br/>ğŸ‘¤ User sees corrections<br/>ğŸ‰ **EXIT POINT**")]
        end
        
        TEXT_FIELD ==>|"**ğŸš€ KEYSTROKE**<br/>âš¡ Immediate capture"| DOM_EVENTS
        DOM_EVENTS ==>|"**ğŸ“Š EXTRACT DATA**<br/>ğŸ“ text, caret, timestamp"| PIPELINE_INGEST
        CORRECTIONS_READY ==>|"**âœ… APPLY EDITS**<br/>ğŸ“Š Score â‰¥ 0.90"| REPLACE_RANGE
        REPLACE_RANGE ==>|"**âš›ï¸ ATOMIC UPDATE**<br/>ğŸ“ Caret preserved"| UPDATED_FIELD
        UPDATED_FIELD -.->|"**ğŸ”„ CONTINUOUS LOOP**<br/>â™¾ï¸ Typing cycle"| TEXT_FIELD
    end
    
    %% ========================================
    %% PLATFORM LAYER
    %% ========================================
    subgraph PLATFORM ["ğŸŒ **PLATFORM LAYER** (4-5)<br/>ğŸ“š Docs: adr/0003-architecture-constraints.md, system_principles.md"]
        direction TB
        
        WEB["**â‘£ Web Platform**<br/>web-demo/src/App.tsx<br/>React + TypeScript + Vite<br/>Direct pipeline.ingest() calls"]
        MAC["**â‘¤ macOS Platform**<br/>Swift + AX API + FFI<br/>NSStatusItem menu bar app<br/>*Needs creation*"]
        
        NORMALIZE["**Platform Bridge**<br/>Normalizes all inputs:<br/>{text, caret, atMs}<br/>Cross-platform compatibility"]
    end
    
    %% ========================================
    %% DUAL ARCHITECTURE: TYPESCRIPT (CURRENT) + RUST (TARGET)
    %% ========================================
    subgraph DUAL_ARCH ["ğŸ”„ **DUAL ARCHITECTURE TRANSITION**<br/>Feature flag: <code>USE_WASM_CORE</code> (default OFF)"]
        direction TB
        
        subgraph TS_CURRENT ["**ğŸŸ¢ CURRENT: TypeScript Implementation**<br/>ğŸ“ core/ - Fully functional, production-ready<br/>ğŸ¯ Used by web demo, all tests passing"]
            TS_SCHEDULER["**ğŸŸ¢ TS SweepScheduler**<br/>ğŸ“ core/sweepScheduler.ts<br/>ğŸš€ Orchestrates all transformers<br/>ğŸ“Š Creates DiffusionController<br/>âš¡ Production implementation"]
            TS_DIFFUSION["**ğŸŸ¢ TS DiffusionController**<br/>ğŸ“ core/diffusionController.ts<br/>ğŸ¬ Streaming ticks + visual feedback<br/>ğŸ”„ State management<br/>ğŸ“¡ UI event emission"]
            TS_CONFIDENCE["**ğŸŸ¢ TS Confidence System**<br/>ğŸ“ core/confidenceGate.ts<br/>ğŸ§® 4D mathematical scoring<br/>âš–ï¸ Dynamic thresholds<br/>ğŸ¯ Production-ready"]
        end
        
        subgraph RUST_TARGET ["**ğŸ”´ TARGET: Rust Implementation**<br/>ğŸ“ crates/core-rs/ - Partial stubs, migration target<br/>ğŸ¯ Cross-platform performance goal"]
            RUST_ENGINE["**ğŸ”´ Rust Engine**<br/>ğŸ“ crates/core-rs/src/engine.rs<br/>ğŸš§ Placeholder stub<br/>ğŸ¯ Should replace TS orchestrator<br/>âš ï¸ Not yet implemented"]
            RUST_TAPESTRY["**ğŸ”´ Rust Tapestry**<br/>ğŸ“ crates/core-rs/src/tapestry.rs<br/>ğŸš§ Basic span tracking stub<br/>ğŸ¯ Should replace TS activeRegion<br/>âš ï¸ Minimal implementation"]
            RUST_CONFIDENCE["**ğŸ”´ Rust Confidence**<br/>ğŸ“ crates/core-rs/src/confidence.rs<br/>ğŸš§ Basic threshold stub<br/>ğŸ¯ Should replace TS confidenceGate<br/>âš ï¸ Missing 4D scoring"]
            RUST_FFI["**ğŸŸ¡ Rust FFI Bridge**<br/>ğŸ“ crates/core-rs/src/ffi.rs<br/>ğŸ”— C bindings for macOS<br/>ğŸŒ WASM bindings for web<br/>âš ï¸ Bindings exist, core missing"]
        end
        
        MIGRATION_NOTE["**ğŸ”„ Migration Status:**<br/>ğŸ“ ADR-0005 mandates Rust-first orchestrator<br/>ğŸ§­ Strategy: TS-first now â†’ Rust WASM behind flag<br/>ğŸ§ª CI runs tests in TS-only and WASM-enabled modes<br/>âš¡ TS implementation is production-ready<br/>ğŸ“‹ Progressive handoff of inner engines"]
        
        TS_SCHEDULER -.->|"**ğŸš¨ MIGRATION REQUIRED**<br/>ğŸ”„ Replace with Rust Engine<br/>ğŸ“‹ ADR-0005 mandate"| RUST_ENGINE
        TS_CONFIDENCE -.->|"**ğŸš¨ MIGRATION REQUIRED**<br/>ğŸ”„ Replace with Rust scoring<br/>ğŸ“Š 4D algorithm port"| RUST_CONFIDENCE
        TS_DIFFUSION -.->|"**ğŸš¨ MIGRATION REQUIRED**<br/>ğŸ”„ Replace with Rust Tapestry<br/>ğŸ¯ Cross-platform goal"| RUST_TAPESTRY
    end
    
    %% ========================================
    %% CORE PIPELINE ENGINE (TYPESCRIPT CURRENT)
    %% ========================================
    subgraph CORE ["âš¡ **CORE PIPELINE ENGINE** (6-9) - TYPESCRIPT CURRENT<br/>ğŸ“š Docs: adr/0005-rust-first-orchestrator.md (ğŸš¨ VIOLATION: Should be Rust)"]
        direction TB
        
        ENTRY["**â‘¥ System Entry**<br/>index.ts boot() function<br/>Creates all components<br/>Wires monitorâ†’schedulerâ†’diffusion"]
        
        subgraph MONITORING ["**INPUT MONITORING** (7)"]
            TM["**TypingMonitor**<br/>core/typingMonitor.ts<br/>Emits TypingEvent stream<br/>Manages event listeners"]
            SEC["**SecurityContext**<br/>core/security.ts<br/>Detects password/IME states<br/>Blocks unsafe operations"]
        end
        
        SS["**â‘§ SweepScheduler**<br/>core/sweepScheduler.ts<br/>Pause detection (300ms)<br/>Triggers engine execution<br/>Controls tickOnce() intervals"]
        
        subgraph DIFFUSION ["**DIFFUSION CONTROL** (9)"]
            DC["**DiffusionController**<br/>core/diffusionController.ts<br/>State: {text, caret, frontier}<br/>Unicode: Intl.Segmenter"]
            ARP["**ActiveRegionPolicy**<br/>core/activeRegionPolicy.ts<br/>Sentence window: Nâˆˆ[2,5] to left; ends at caret<br/>Ranges: Render vs Context"]
            REGION_VIZ["**Visual:**<br/>[â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘] caret<br/>â–  Processing zone<br/>â–¡ Safe (ahead of cursor)"]
        end
    end
    
    %% ========================================
    %% THREE-STAGE TRANSFORMER PIPELINE
    %% ========================================
    subgraph TRANSFORMERS ["ğŸ”§ **THREE-STAGE PIPELINE** (10a-c)<br/>ğŸ“š Docs: guide/reference/three-stage-pipeline.md, PRD.md (REQ-STREAMED-DIFFUSION)"]
        direction LR
        
        subgraph STAGE1 ["**ğŸ§¹ STAGE 1: NOISE** ğŸŸ¢<br/>ğŸ“ Mostâ€‘likely intended words<br/>ğŸ¯ Priors: keyboard proximity, word frequency<br/>ğŸš« NO grammar/punctuation changes"]
            T1["**ğŸŸ¢ Noise Transformer**<br/>ğŸ“ engines/noiseTransformer.ts<br/>âš¡ Trigger: Word boundaries<br/>â±ï¸ Timing: Immediate (< 5ms)<br/>ğŸ”’ Caret-safe only"]
            T1_RULES["**ğŸŸ¢ Active Rules:**<br/>â€¢ ğŸ¯ Word substitution (60+ patterns)<br/>â€¢ ğŸ”„ Letter transposition detection<br/>â€¢ ğŸ§¹ Whitespace normalization<br/>â€¢ ğŸ“ Keyboard-proximity priors"]
            DENOISE_API["**ğŸŸ¢ Denoising API**<br/>ğŸ“ core/api/denoise.ts<br/>ğŸ”§ Comprehensive fuzzy correction<br/>ğŸ§ª Testing & integration scenarios<br/>ğŸ“Š 100+ substitution patterns"]
        end
        
        LANG_GATE["**ğŸŸ¢ Language Detection**<br/>ğŸ“ core/languageDetection.ts<br/>ğŸŒ English vs Other detection<br/>ğŸšª Pipeline gating logic<br/>ğŸ“ English: Full pipeline<br/>ğŸ”§ Other: Noise only"]
        
        subgraph STAGE2 ["**ğŸ“š STAGE 2: CONTEXT** ğŸŸ¢<br/>ğŸªŸ Window: current sentence Â±2<br/>âš–ï¸ Weights: SÂ±1=1.0, SÂ±2=0.5<br/>ğŸ”’ Never edit at/after caret"]
            T2["**ğŸŸ¢ Context Transformer**<br/>ğŸ“ engines/contextTransformer.ts<br/>â¸ï¸ Trigger: Pause (500ms)<br/>ğŸ¤– LM inference (~30ms)<br/>ğŸ§  Dual-context integration"]
            T2_EXAMPLES["**ğŸŸ¢ Corrections:**<br/>â€¢ ğŸ“ Grammar, syntax, semantics<br/>â€¢ ğŸ”¤ Punctuation, capitalization<br/>â€¢ ğŸ”— Cross-sentence coherence<br/>â€¢ ğŸ§¹ Deterministic repairs"]
            T2_LM_INTEGRATION["**ğŸŸ¢ LM Integration:**<br/>â€¢ ğŸ“Š Context manager integration<br/>â€¢ ğŸ¯ Prompt engineering<br/>â€¢ âœ… Output validation<br/>â€¢ ğŸ”’ Caret safety enforcement"]
        end
        
        subgraph STAGE3 ["**ğŸ¨ STAGE 3: TONE** ğŸŸ¢<br/>ğŸ­ Options: None, Casual, Professional<br/>âœï¸ May change wording/grammar/punctuation<br/>ğŸ”’ Never edit at/after caret<br/>ğŸ“ Scope: last N sentences (CPU:10, higher:20)"]
            T3["**ğŸŸ¢ Tone Transformer**<br/>ğŸ“ engines/toneTransformer.ts<br/>â³ Trigger: After Context<br/>â±ï¸ Timing: Analysis (~50ms)<br/>ğŸ“Š Baseline detection"]
            T3_POLISH["**ğŸŸ¢ Features:**<br/>â€¢ ğŸ“ˆ Baseline tone detection<br/>â€¢ âœï¸ Minimalâ€‘diff rewrites<br/>â€¢ ğŸ“„ Document consistency<br/>â€¢ ğŸ¯ Target tone adjustment"]
            T3_TOGGLE["**ğŸŸ¡ Toggle Control**<br/>ğŸ”˜ Default: ON<br/>â¹ï¸ OFF midâ€‘process:<br/>finish inâ€‘flight, stop new<br/>ğŸ›ï¸ UX needs enhancement"]
        end
        
        T1 ===>|"**ğŸ§¹ CLEAN WORDS**<br/>âœ… Correctly spelled<br/>ğŸ“ Ready for context<br/>âš¡ Stage 1 â†’ 2"| T2
        T2 ===>|"**ğŸ“š POLISHED TEXT**<br/>âœ… Grammar complete<br/>ğŸ¨ Ready for tone<br/>âš¡ Stage 2 â†’ 3"| T3
        T3_TOGGLE -.->|"**ğŸ›ï¸ TOGGLE CONTROL**<br/>ğŸ”˜ ON/OFF control"| T3
    end
    
    %% ========================================
    %% TONE CONTROL SUBSYSTEM
    %% ========================================
    subgraph TONE_CONTROL ["ğŸ¨ **TONE CONTROL SUBSYSTEM**"]
        direction TB
        
        TONE_TOGGLE["**Toggle Control**<br/>Default: ON<br/>User: Enable/Disable<br/>OFF midâ€‘process: finish inâ€‘flight"]
        TONE_OPTIONS["**Tone Selection**<br/>None (passâ€‘through)<br/>Casual, Professional<br/>Scope: last N sentences"]
        TONE_DETECTOR["**Tone Detector**<br/>LM classifier<br/>Baseline tone vector<br/>Document assessment"]
        TONE_ANALYSIS["**Tone Analysis**<br/>Plan minimalâ€‘diff adjustments<br/>Ï„_tone (0.85) âˆ§ Ï„_commit (0.90)"]
        
        TONE_TOGGLE -->|"**Control**"| TONE_OPTIONS
        TONE_OPTIONS -->|"**Parameters**"| TONE_DETECTOR
        TONE_DETECTOR -->|"**Baseline**"| TONE_ANALYSIS
        TONE_ANALYSIS -->|"**Adjustments**"| T3
    end
    
    %% ========================================
    %% LANGUAGE MODEL SUBSYSTEM
    %% ========================================
    subgraph LM ["ğŸ§  **LANGUAGE MODEL SUBSYSTEM** (11)<br/>ğŸ“š Docs: guide/reference/lm.md, guide/reference/lm-worker.md"]
        direction TB
        
        LM_CONTEXT_MGR["**ğŸŸ¢ LM Context Manager**<br/>core/lm/contextManager.ts<br/>ğŸ”„ Dual-Context Architecture<br/>ğŸ“Š Wide Context: Full document<br/>ğŸ” Close Context: Â±2-5 sentences<br/>âœ… Click-to-activate initialization"]
        
        LM_FACTORY["**ğŸŸ¢ LM Factory**<br/>core/lm/factory.ts<br/>ğŸ“¦ createDefaultLMAdapter()<br/>ğŸ”§ Device detection + fallback<br/>âš™ï¸ Configuration management"]
        
        LM_CLIENT["**ğŸŸ¢ TransformersClient**<br/>core/lm/transformersClient.ts<br/>ğŸš« Single-flight + abort<br/>â±ï¸ Device-tier adaptive cooldown<br/>ğŸ“ˆ Tracks runs + stale drops"]
        
        LM_RUNNER["**ğŸŸ¢ TransformersRunner**<br/>core/lm/transformersRunner.ts<br/>ğŸ¤– Qwen2.5-0.5B-Instruct<br/>ğŸŒŠ Token-by-token streaming<br/>ğŸ”’ Singleton pattern"]
        
        LM_WORKER["**ğŸŸ¢ LM Worker**<br/>web-demo/src/worker/lmWorker.ts<br/>ğŸ§µ Module Worker (browser)<br/>ğŸŒŠ Streams tokens; aborts stale<br/>ğŸ’¾ Memory isolation"]
        
        subgraph LM_TIERS ["**ğŸŸ¢ Device Tiers**<br/>ğŸ“Š Adaptive Performance<br/>ğŸ¯ Scope: N sentences<br/>(CPU: 10, WebGPU/WASM: 20)"]
            WEBGPU["**ğŸŸ¢ WebGPU**<br/>ğŸš€ 48 tokens max<br/>â±ï¸ 160ms cooldown<br/>âš¡ ~15ms latency"]
            WASM["**ğŸŸ¢ WASM**<br/>âš–ï¸ 24 tokens max<br/>â±ï¸ 240ms cooldown<br/>ğŸŒ ~30ms latency"]
            CPU["**ğŸŸ¢ CPU**<br/>ğŸ”‹ 16 tokens max<br/>â±ï¸ 400ms cooldown<br/>ğŸ¢ ~100ms latency"]
        end
        
        LM_CONTEXT_MGR -->|"**Context Windows**<br/>Wide + Close data"| LM_FACTORY
        LM_FACTORY -->|"**Creates (node/tests)**<br/>Direct instantiation"| LM_CLIENT
        LM_CLIENT -->|"**Manages**<br/>Lifecycle control"| LM_RUNNER
        LM_FACTORY -->|"**Creates (browser)**<br/>Worker instantiation"| LM_WORKER
        LM_WORKER -->|"**Bridges**<br/>Cross-thread communication"| LM_RUNNER
    end
    
    %% ========================================
    %% CONFIDENCE & STAGING SYSTEM
    %% ========================================
    subgraph CONFIDENCE ["âš–ï¸ **CONFIDENCE & STAGING** (12)<br/>ğŸ“š Docs: guide/reference/confidence-system.md, adr/0002-caret-safe-diff.md"]
        direction TB
        
        CG["**ğŸŸ¢ Confidence Gate**<br/>ğŸ“ core/confidenceGate.ts<br/>ğŸ§® Mathematical scoring<br/>ğŸ“Š 4-dimensional analysis<br/>ğŸ¯ All transformer proposals<br/>âœ… Dynamic threshold adjustment"]
        
        CG_MATH["**ğŸŸ¢ Scoring Algorithm:**<br/>â€¢ ğŸ“Š Input fidelity (30%)<br/>â€¢ ğŸ”§ Transform quality (40%)<br/>â€¢ ğŸ”— Context coherence (20%)<br/>â€¢ â° Temporal decay (10%)<br/>ğŸ“ˆ Combined weighted score"]
        
        SB["**ğŸŸ¢ Staging Buffer**<br/>ğŸ“ core/stagingBuffer.ts<br/>ğŸ¤– Proposal state machine<br/>ğŸ§¹ Cleanup stale proposals<br/>ğŸ¯ Caret movement triggers<br/>ğŸ“Š Score tracking"]
        
        SB_STATES["**ğŸŸ¢ State Machine:**<br/>ğŸŸ¡ HOLD â†’ Waiting for confidence<br/>ğŸŸ¢ COMMIT â†’ Apply to text<br/>ğŸ”´ DISCARD â†’ Reject proposal<br/>ğŸ”„ ROLLBACK â†’ Caret interference"]
        
        THRESHOLDS["**ğŸŸ¢ Decision Thresholds:**<br/>ğŸ“Š Ï„_input = 0.65 (try Context)<br/>âœ… Ï„_commit = 0.90 (apply changes)<br/>ğŸ¨ Ï„_tone = 0.85 (Tone gate)<br/>ğŸ—‘ï¸ Ï„_discard = 0.30 (reject)<br/>ğŸ”’ Dynamic near-caret adjustment"]
        
        LANG_DETECT["**ğŸŸ¢ Language Detection**<br/>ğŸ“ core/languageDetection.ts<br/>ğŸŒ English vs Other detection<br/>ğŸšª Pipeline gating control<br/>ğŸ“ Full pipeline: English only<br/>ğŸ”§ Noise only: Other languages"]
        
        CG -->|"**Confidence Score [0,1]**<br/>Mathematical assessment"| SB
        LANG_DETECT -->|"**Language Gate**<br/>Pipeline scope control"| CG
    end
    
    %% ========================================
    %% VALIDATION & MERGE
    %% ========================================
    subgraph VALIDATION ["ğŸ§© **VALIDATION & MERGE** (13)<br/>ğŸ“š Docs: guide/reference/active-region-design.md, adr/0002-caret-safe-diff.md"]
        direction TB
        
        TAP["**ğŸŸ¢ Active Region Tracker**<br/>ğŸ“ core/tapestry.ts<br/>ğŸ“Š Track validated spans<br/>ğŸ’¾ {original, corrected, confidence}<br/>ğŸš« Prevent re-processing<br/>ğŸ”„ State management"]
        
        TAP_DATA["**ğŸŸ¢ Capabilities:**<br/>â€¢ ğŸ“ Span tracking/merging<br/>â€¢ ğŸ“Š Confidence score storage<br/>â€¢ â° Applied timestamps<br/>â€¢ ğŸ”’ Re-processing prevention<br/>â€¢ ğŸ”„ Rollback state management"]
        
        CONFLICT_RESOLVER["**ğŸŸ¢ Conflict Resolver**<br/>ğŸ“ engines/conflictResolver.ts<br/>ğŸ”€ Merge overlapping proposals<br/>ğŸ“‹ Precedence: noise > lm > context > tone<br/>ğŸ“ Prefer longer spans<br/>ğŸš« Eliminate conflicts"]
        
        BACKFILL["**ğŸŸ¢ Backfill Consistency**<br/>ğŸ“ engines/backfillConsistency.ts<br/>ğŸ” Text consistency validation<br/>ğŸ§¹ Gap detection and repair<br/>âš¡ Post-correction cleanup"]
        
        DMG["**ğŸŸ¢ Diff/Merge Gate**<br/>ğŸ“ utils/diff.ts<br/>âš›ï¸ replaceRange() atomic ops<br/>ğŸ›¡ï¸ Comprehensive caret protection<br/>ğŸšª All text changes gateway"]
        
        DMG_SAFETY["**ğŸŸ¢ Safety Guarantees:**<br/>â€¢ ğŸš« Never edits at/after caret<br/>â€¢ ğŸ”¤ UTF-16 surrogate pair safe<br/>â€¢ âš›ï¸ Atomic all-or-nothing<br/>â€¢ ğŸ¯ Preserves cursor position<br/>â€¢ ğŸ›¡ï¸ Exception-safe rollback"]
        
        UNDO["**ğŸŸ¢ Undo Isolation**<br/>ğŸ“ core/undoIsolation.ts<br/>ğŸ¯ Critical UX component<br/>ğŸ”€ Separate system/user undo<br/>â° 100-200ms time windows<br/>ğŸ”„ Internal rollback capability"]
        
        GROUP_UNDO["**ğŸŸ¢ Group Undo**<br/>ğŸ“ ui/groupUndo.ts<br/>ğŸ“¦ Batch related edits<br/>ğŸ‘¤ User vs system separation<br/>â° Time-based grouping"]
        
        TAP -->|"**Validated Spans**<br/>Confidence data"| BACKFILL
        BACKFILL -->|"**Consistent Text**<br/>Gap-free content"| DMG
        DMG -->|"**System Edits**<br/>Atomic operations"| UNDO
        UNDO -->|"**Edit Grouping**<br/>Batch operations"| GROUP_UNDO
    end
    
    %% ========================================
    %% UI FEEDBACK SYSTEM
    %% ========================================
    subgraph UI_FEEDBACK ["ğŸ¨ **UI FEEDBACK SYSTEM** (14)<br/>ğŸ“š Docs: PRD.md (REQ-VISUAL-SWAP, REQ-A11Y-MOTION), system_principles.md"]
        direction LR
        
        UI_HIGH["**ğŸŸ¢ UI Highlighter**<br/>ğŸ“ ui/highlighter.ts<br/>ğŸ“¡ emitActiveRegion() events<br/>ğŸ“ Called from DiffusionController<br/>âœ¨ Subtle region highlighting<br/>ğŸ¨ Visual feedback coordination"]
        
        UI_SWAP["**ğŸŸ¡ SwapRenderer**<br/>ğŸ“ ui/swapRenderer.ts<br/>ğŸ”§ Needs polish<br/>ğŸ”„ Mechanical letter swap<br/>ğŸ¯ Target: Braille markers<br/>ğŸ¬ Animation coordination"]
        
        UI_LIVE["**ğŸŸ¢ LiveRegion**<br/>ğŸ“ ui/liveRegion.ts<br/>â™¿ WCAG 2.2 AA compliant<br/>ğŸ“¢ Screen reader announcements<br/>ğŸ’¬ 'text updated behind cursor'<br/>ğŸ”Š Accessibility integration"]
        
        UI_MOTION["**ğŸŸ¢ Motion Detection**<br/>ğŸ“ ui/motion.ts<br/>ğŸ­ prefers-reduced-motion<br/>ğŸ¬ Animation fallbacks<br/>â™¿ Accessibility compliance"]
        
        UI_SECURITY["**ğŸŸ¢ Security Detection**<br/>ğŸ“ ui/securityDetection.ts<br/>ğŸ” Password field detection<br/>ğŸš« IME state awareness<br/>ğŸ›¡ï¸ Safe operation gating"]
        
        UI_EVENTS["**ğŸŸ¢ Event Coordination:**<br/>â€¢ ğŸ“¡ mindtype:activeRegion<br/>â€¢ âœ¨ mindtype:highlight<br/>â€¢ ğŸ“¢ Screen reader announcements<br/>â€¢ ğŸ­ Reduced motion detection<br/>â€¢ ğŸŒ Cross-browser compatibility"]
        
        UI_HIGH -->|"**Highlight Events**<br/>Visual feedback"| UI_SWAP
        UI_HIGH -->|"**Region Events**<br/>Accessibility"| UI_LIVE
        UI_MOTION -->|"**Animation Control**<br/>Preference detection"| UI_SWAP
        UI_SECURITY -->|"**Safety Gates**<br/>Operation blocking"| UI_HIGH
    end
    
    %% ========================================
    %% CONTINUOUS LOOP EXPLANATION
    %% ========================================
    subgraph LOOP_DETAIL ["ğŸ”„ **TYPING LOOP EXAMPLE**"]
        direction TB
        
        LOOP_TITLE["**ğŸ“ Typing Example: 'helloo thr weathfr'**<br/>ğŸ”¢ Complete Pipeline Execution Trace"]
        
        RUNS["**ğŸ“Š Pipeline Execution Flow:**<br/>1-6: 'helloo' â†’ ğŸ”¨ Building word, no changes<br/>7: ' ' â†’ ğŸ§¹ 'helloo' â†’ 'hello' (NOISE)<br/>8-10: 'thr' â†’ ğŸ”¨ Building next word<br/>11: ' ' â†’ ğŸ§¹ 'thr' â†’ 'the' (NOISE)<br/>12: 'weathfr' â†’ ğŸ”¨ Building final word<br/>13: Pause 500ms â†’ ğŸ“š Context analysis<br/>14: Grammar check â†’ ğŸ¨ Tone analysis<br/>**âœ… Final Result:** 'Hello, the weather'"]
        
        LOOP_PERFORMANCE["**âš¡ Performance Characteristics:**<br/>â€¢ ğŸ“ˆ 90%+ runs: No changes needed<br/>â€¢ ğŸ¯ Only word boundaries trigger fixes<br/>â€¢ âœ… Validated text regions skipped<br/>â€¢ ğŸ¬ 60fps UI throttling maintained<br/>â€¢ â±ï¸ ~5ms noise, ~30ms context, ~50ms tone<br/>â€¢ ğŸ§  Memory efficient: O(1) hot paths"]
        
        LOOP_METRICS["**ğŸ“Š Key Metrics (Current):**<br/>â€¢ ğŸ§ª 255 tests passing (95.11% coverage)<br/>â€¢ ğŸ¯ 16 denoising test cases (50% pass)<br/>â€¢ âš¡ <100ms total pipeline latency<br/>â€¢ ğŸ”’ 100% caret safety compliance<br/>â€¢ ğŸŒ Cross-browser compatibility"]
    end
    
    %% ========================================
    %% CONFIGURATION & TESTING SUBSYSTEM
    %% ========================================
    subgraph CONFIG_TEST ["âš™ï¸ **CONFIGURATION & TESTING**<br/>ğŸ“š Docs: guide/reference/config-flags.md, qa/acceptance/ (BDD scenarios)"]
        direction TB
        
        CONFIG["**ğŸŸ¢ Configuration System**<br/>ğŸ“ config/defaultThresholds.ts<br/>âš™ï¸ Pipeline parameters<br/>ğŸ›ï¸ Confidence thresholds<br/>â±ï¸ Timing controls<br/>ğŸ“Š Device tier settings"]
        
        TESTING["**ğŸŸ¢ Test Infrastructure**<br/>ğŸ“ tests/ (255 tests)<br/>ğŸ§ª Unit tests per component<br/>ğŸ”— Integration test suites<br/>ğŸ¯ 95.11% code coverage<br/>ğŸ”’ Caret safety validation"]
        
        E2E_TESTS["**ğŸŸ¢ End-to-End Testing**<br/>ğŸ“ e2e/ (Playwright)<br/>ğŸŒ Browser automation<br/>ğŸ‘¤ User interaction simulation<br/>ğŸ” Visual regression testing<br/>ğŸ“Š Performance benchmarking"]
        
        DENOISE_TESTS["**ğŸŸ¢ Denoising Test Suite**<br/>ğŸ“ tests/denoise.spec.ts<br/>ğŸ§ª 16 fuzzy text test cases<br/>ğŸ“Š 50% pass rate baseline<br/>ğŸ”„ Regression detection<br/>ğŸ¯ Comprehensive pattern coverage"]
        
        CONFIG -->|"**Runtime Parameters**<br/>Threshold configuration"| CG
        CONFIG -->|"**Device Settings**<br/>Performance tuning"| LM_TIERS
        TESTING -->|"**Validation Data**<br/>Test scenarios"| DENOISE_TESTS
        E2E_TESTS -->|"**Integration Validation**<br/>End-to-end flows"| TESTING
    end
    
    %% ========================================
    %% PRIMARY DATA FLOW (Left to Right)
    %% ========================================
    
    %% ========================================
    %% PRIMARY DATA FLOW CONNECTIONS (Left to Right)
    %% ========================================
    
    %% â•â•â• CRITICAL INPUT FLOW (High Priority) â•â•â•
    PIPELINE_INGEST ===>|"**ğŸš€ TYPING EVENT**<br/>ğŸ“¦ TypingEvent {text, caret, atMs}<br/>âš¡ Critical path start"| ENTRY
    
    %% â•â•â• PLATFORM INTEGRATION (Foundation) â•â•â•
    WEB ==>|"**ğŸŒ DIRECT CALL**<br/>ğŸ”§ handleTextChange() in App.tsx<br/>ğŸ“± Web platform active"| ENTRY
    MAC -->|"**ğŸ”® FFI BRIDGE (PLANNED)**<br/>ğŸ Swift AX API â†’ Rust core<br/>ğŸš§ Future implementation"| RUST_FFI
    RUST_FFI -.->|"**âš ï¸ NOT YET CONNECTED**<br/>ğŸš§ Rust core incomplete"| ENTRY
    
    %% Core Pipeline Flow (Nodes 6-9) - CURRENT TYPESCRIPT IMPLEMENTATION
    ENTRY -->|"**Event Distribution**<br/>Creates monitor + scheduler"| TM
    ENTRY -->|"**Security Context**<br/>Injects security checks"| SEC
    ENTRY -->|"**Creates TS Components**<br/>Uses current TS implementation"| TS_SCHEDULER
    TM -->|"**Debounced Stream**<br/>Filtered keystroke events"| SS
    SEC -->|"**Security Signals**<br/>Blocks unsafe operations"| SS
    TS_SCHEDULER -->|"**Currently Implements**<br/>What SS should do"| SS
    
    %% Scheduling to Diffusion (Nodes 8-9) - CORRECTED: SS owns DC
    SS -->|"**Creates & Manages**<br/>Internal diffusion controller"| DC
    SS -->|"**Region Policy**<br/>3-8 word window config"| ARP
    
    %% SweepScheduler Orchestrates All Transformers - ACTUAL FLOW
    SS -->|"**Direct Call**<br/>runSweeps() â†’ noiseTransform()"| T1
    SS -->|"**Language Gate**<br/>detectLanguage() â†’ English check"| LANG_DETECT
    LANG_DETECT -->|"**Pipeline Control**<br/>English: Full | Other: Noise only"| SS
    SS -->|"**Pause Processing**<br/>contextTransform() call"| T2
    SS -->|"**Tone Processing**<br/>planAdjustments() call"| T3
    
    %% DiffusionController Internal Operations
    DC -->|"**Streaming Ticks**<br/>tickOnce() â†’ noiseTransform()"| T1
    DC -->|"**Visual Feedback**<br/>emitActiveRegion() calls"| UI_HIGH
    DC -->|"**Swap Events**<br/>renderHighlight() calls"| UI_SWAP
    ARP -->|"**Safety Constraints**<br/>Caret-safe boundaries"| DC
    
    %% LM Integration (Stage 2 Context Processing)
    T2 -->|"**Context Request**<br/>Sentence + surrounding context"| LM_CONTEXT_MGR
    LM_CONTEXT_MGR -->|"**Dual Context**<br/>Wide + Close windows"| LM_FACTORY
    LM_FACTORY -->|"**LM Adapter**<br/>Configured for context"| T2
    LM_RUNNER -->|"**Token Stream**<br/>Incremental LM corrections"| T2
    
    %% â•â•â• TRANSFORMER PROPOSAL COLLECTION (Critical Merge) â•â•â•
    T1 ===>|"**ğŸ§¹ NOISE PROPOSALS**<br/>ğŸ”§ Typo corrections<br/>âš¡ Immediate fixes"| CONFLICT_RESOLVER
    T2 ===>|"**ğŸ“š CONTEXT PROPOSALS**<br/>ğŸ§  Grammar + style fixes<br/>ğŸ¤– LM-powered"| CONFLICT_RESOLVER
    T3 ===>|"**ğŸ¨ TONE PROPOSALS**<br/>âœ¨ Tone consistency<br/>ğŸ­ Style adjustment"| CONFLICT_RESOLVER
    
    %% â•â•â• QUALITY CONTROL PIPELINE (Decision Flow) â•â•â•
    CONFLICT_RESOLVER ===>|"**ğŸ”€ MERGED PROPOSALS**<br/>ğŸš« No overlaps<br/>ğŸ“‹ Prioritized<br/>âš¡ Ready for scoring"| CG
    
    CG ===>|"**ğŸ“Š SCORED PROPOSALS**<br/>ğŸ§® Confidence assessment<br/>âš–ï¸ Mathematical validation<br/>ğŸ¯ Quality gated"| SB
    
    SB ===>|"**âœ… APPROVED EDITS**<br/>ğŸ“Š Score â‰¥ Ï„_commit (0.90)<br/>ğŸšª Quality gate passed<br/>ğŸ¯ Ready for application"| TAP
    
    %% SweepScheduler Calls Backfill (MISSING CONNECTION)
    SS -->|"**Consistency Check**<br/>backfillConsistency() call"| BACKFILL
    
    %% â•â•â• VALIDATION & APPLICATION FLOW (Final Processing) â•â•â•
    CONFLICT_RESOLVER ===>|"**ğŸ”€ RESOLVED PROPOSALS**<br/>ğŸ“ diffusion.applyExternal()<br/>âš¡ Final application"| DC
    DC ===>|"**ğŸ¯ APPLIED CHANGES**<br/>ğŸ“ Text updates + UI feedback<br/>âœ… Changes committed"| TAP
    TAP ==>|"**ğŸ“Š VALIDATED SPANS**<br/>ğŸ’¾ Confidence + tracking data<br/>ğŸ” State management"| DMG
    DMG ===>|"**âš›ï¸ SYSTEM EDITS**<br/>ğŸ”§ Atomic text operations<br/>ğŸ›¡ï¸ Caret-safe"| UNDO
    UNDO ==>|"**ğŸ“¦ EDIT BATCHING**<br/>ğŸ‘¤ User vs system separation<br/>â° Time-based grouping"| GROUP_UNDO
    
    %% â•â•â• UI FEEDBACK INTEGRATION (Visual Response) â•â•â•
    DC ===>|"**ğŸ“¡ ACTIVE REGION**<br/>âœ¨ emitActiveRegion() calls<br/>ğŸ¨ Visual highlighting"| UI_HIGH
    DC ===>|"**ğŸ¬ SWAP EVENTS**<br/>ğŸ”„ renderHighlight() calls<br/>ğŸ­ Mechanical animation"| UI_SWAP
    UI_SECURITY -->|"**ğŸ›¡ï¸ SAFETY OVERRIDE**<br/>ğŸš« Block unsafe operations<br/>ğŸ” Security gating"| DMG
    
    %% â•â•â• FINAL OUTPUT FLOW (Critical Path End) â•â•â•
    UI_SWAP ===>|"**ğŸ¯ TEXT APPLICATION**<br/>ğŸŒ DOM manipulation<br/>ğŸ‰ User sees result"| CORRECTIONS_READY
    
    %% ========================================
    %% FEEDBACK LOOPS (Dotted - Secondary Flow)
    %% ========================================
    
    %% Rollback Paths
    %% Rollback Flow (CORRECTED: SS orchestrates rollback)
    UPDATED_FIELD -.->|"**Caret Moved**<br/>New typing event"| TM
    TM -.->|"**Caret Event**<br/>Position change"| SS
    SS -.->|"**Rollback Trigger**<br/>sb.onCaretMove()"| SB
    SB -.->|"**Rollback Signal**<br/>Overlapping proposals"| DC
    DC -.->|"**System Rollback**<br/>rollbackLastSystemGroup()"| UNDO
    
    %% Region Updates
    ARP -.->|"**Region Update**"| DC
    
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% ğŸ¨ VISUAL STYLING & GESTALT PRINCIPLES
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    %% â•â•â• IMPLEMENTATION STATUS COLORS (Primary Visual Hierarchy) â•â•â•
    classDef ready fill:#c8e6c9,stroke:#2e7d32,stroke-width:3px,color:#1b5e20
    classDef partial fill:#fff3c4,stroke:#f57c00,stroke-width:3px,color:#e65100
    classDef missing fill:#ffcdd2,stroke:#c62828,stroke-width:3px,color:#b71c1c
    
    %% â•â•â• ARCHITECTURAL LAYER COLORS (Gestalt Grouping) â•â•â•
    %% Critical Flow (Bright, High Contrast)
    classDef criticalFlow fill:#e3f2fd,stroke:#0d47a1,stroke-width:4px,color:#0d47a1
    
    %% Input/Output (Green - Natural Flow)
    classDef inputOutput fill:#e8f5e8,stroke:#2e7d32,stroke-width:3px,color:#1b5e20
    
    %% Platform Layer (Blue - Foundation)
    classDef platformLayer fill:#e1f5fe,stroke:#0277bd,stroke-width:2px,color:#01579b
    
    %% Current Implementation (Orange - Active)
    classDef currentImpl fill:#fff3e0,stroke:#f57c00,stroke-width:3px,color:#e65100
    
    %% Target Implementation (Red - Future)
    classDef targetImpl fill:#fce4ec,stroke:#ad1457,stroke-width:2px,color:#880e4f
    
    %% Processing Engines (Purple - Transformation)
    classDef processingEngine fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px,color:#4a148c
    
    %% Intelligence Layer (Teal - AI/LM)
    classDef intelligenceLayer fill:#e0f2f1,stroke:#00695c,stroke-width:2px,color:#004d40
    
    %% Validation & Safety (Amber - Control)
    classDef validationSafety fill:#fff8e1,stroke:#ff8f00,stroke-width:2px,color:#ff6f00
    
    %% User Interface (Indigo - Interaction)
    classDef userInterface fill:#e8eaf6,stroke:#3949ab,stroke-width:2px,color:#283593
    
    %% Documentation & Testing (Green - Support)
    classDef supportSystem fill:#f1f8e9,stroke:#689f38,stroke-width:2px,color:#33691e
    
    %% â•â•â• SPECIAL EMPHASIS STYLES â•â•â•
    %% Entry/Exit Points (Bold, High Visibility)
    classDef entryExit fill:#fff,stroke:#000,stroke-width:4px,color:#000
    
    %% Bug/Violation Flags (Red Alert)
    classDef bugFlag fill:#ffebee,stroke:#d32f2f,stroke-width:3px,color:#c62828,stroke-dasharray: 5 5
    
    %% Migration Path (Dashed, Transition)
    classDef migrationPath fill:#f5f5f5,stroke:#757575,stroke-width:2px,stroke-dasharray: 10 5
    
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% ğŸ¨ GESTALT VISUAL HIERARCHY APPLICATION
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    %% â•â•â• CRITICAL FLOW (High Contrast, Bold) â•â•â•
    class TEXT_FIELD,UPDATED_FIELD entryExit
    class TEXT_LOOP,TEXT_INPUT,TEXT_OUTPUT criticalFlow
    
    %% â•â•â• INPUT/OUTPUT FLOW (Green - Natural Progression) â•â•â•
    class DOM_EVENTS,PIPELINE_INGEST,CORRECTIONS_READY,REPLACE_RANGE inputOutput
    
    %% â•â•â• PLATFORM FOUNDATION (Blue - Stable Base) â•â•â•
    class PLATFORM,WEB,MAC,NORMALIZE platformLayer
    
    %% â•â•â• CURRENT IMPLEMENTATION (Orange - Active System) â•â•â•
    class DUAL_ARCH,TS_CURRENT,TS_SCHEDULER,TS_DIFFUSION,TS_CONFIDENCE currentImpl
    class CORE,ENTRY,MONITORING,TM,SEC,SS,DIFFUSION,DC,ARP,REGION_VIZ currentImpl
    
    %% â•â•â• TARGET IMPLEMENTATION (Pink - Future Vision) â•â•â•
    class RUST_TARGET,RUST_ENGINE,RUST_TAPESTRY,RUST_CONFIDENCE,RUST_FFI targetImpl
    class MIGRATION_NOTE migrationPath
    
    %% â•â•â• PROCESSING ENGINES (Purple - Transformation) â•â•â•
    class TRANSFORMERS,STAGE1,STAGE2,STAGE3 processingEngine
    class T1,T1_RULES,DENOISE_API,T2,T2_EXAMPLES,T2_LM_INTEGRATION,T3,T3_POLISH processingEngine
    class LANG_GATE processingEngine
    
    %% â•â•â• INTELLIGENCE LAYER (Teal - AI/LM) â•â•â•
    class LM,LM_CONTEXT_MGR,LM_FACTORY,LM_CLIENT,LM_RUNNER,LM_WORKER intelligenceLayer
    class LM_TIERS,WEBGPU,WASM,CPU intelligenceLayer
    
    %% â•â•â• CONFIDENCE & CONTROL (Amber - Decision Making) â•â•â•
    class CONFIDENCE,CG,CG_MATH,SB,SB_STATES,THRESHOLDS,LANG_DETECT validationSafety
    
    %% â•â•â• VALIDATION & SAFETY (Amber - Quality Control) â•â•â•
    class VALIDATION,TAP,TAP_DATA,CONFLICT_RESOLVER,BACKFILL validationSafety
    class DMG,DMG_SAFETY,UNDO,GROUP_UNDO validationSafety
    
    %% â•â•â• USER INTERFACE (Indigo - Human Interaction) â•â•â•
    class UI_FEEDBACK,UI_HIGH,UI_SWAP,UI_LIVE,UI_MOTION,UI_SECURITY,UI_EVENTS userInterface
    class TONE_CONTROL,TONE_TOGGLE,TONE_OPTIONS,TONE_DETECTOR,TONE_ANALYSIS userInterface
    
    %% â•â•â• SUPPORT SYSTEMS (Green - Infrastructure) â•â•â•
    class LOOP_DETAIL,LOOP_TITLE,RUNS,LOOP_PERFORMANCE,LOOP_METRICS supportSystem
    class CONFIG_TEST,CONFIG,TESTING,E2E_TESTS,DENOISE_TESTS supportSystem
    
    %% â•â•â• SPECIAL EMPHASIS (Bugs, Migration, Critical Points) â•â•â•
    %% Bug Flags (ADR Violations)
    class CORE bugFlag
    class MIGRATION_NOTE bugFlag
    
    %% Migration Paths (Transition States)
    class TS_SCHEDULER,TS_CONFIDENCE,TS_DIFFUSION migrationPath
    class RUST_ENGINE,RUST_TAPESTRY,RUST_CONFIDENCE migrationPath
    
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% IMPLEMENTATION STATUS (v0.4 - Updated September 2025)
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    %% ğŸŸ¢ READY: Core pipeline, transformers, LM system, confidence gating
    class ENTRY,TM,SEC,SS,DC,ARP ready
    class T1,T1_RULES,DENOISE_API ready
    class T2,T2_EXAMPLES,T2_LM_INTEGRATION ready
    class T3,T3_POLISH ready
    class LM_CONTEXT_MGR,LM_FACTORY,LM_CLIENT,LM_RUNNER,LM_WORKER ready
    class CG,CG_MATH,SB,SB_STATES,THRESHOLDS,LANG_DETECT ready
    class TAP,TAP_DATA,CONFLICT_RESOLVER,BACKFILL,DMG,DMG_SAFETY,UNDO,GROUP_UNDO ready
    class UI_HIGH,UI_LIVE,UI_MOTION,UI_SECURITY,UI_EVENTS ready
    class WEB,NORMALIZE ready
    class WEBGPU,WASM,CPU ready
    class LANG_GATE ready
    class CONFIG,TESTING,E2E_TESTS,DENOISE_TESTS ready
    
    %% ğŸŸ¡ PARTIAL: UI components needing polish, tone UX controls
    class UI_SWAP,T3_TOGGLE,TONE_TOGGLE,TONE_OPTIONS,TONE_ANALYSIS partial
    
    %% ğŸ”´ MISSING: Platform implementations not yet built
    class MAC missing
    
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% ğŸ“š DOCUMENTATION REFERENCE MAP
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% 
    %% CORE REQUIREMENTS & CONSTRAINTS:
    %% â€¢ PRD.md - Functional requirements (REQ-*), success metrics, constraints
    %% â€¢ system_principles.md - Behavioral principles, human-centric design
    %% â€¢ adr/0003-architecture-constraints.md - On-device processing, privacy
    %% â€¢ adr/0005-rust-first-orchestrator.md - ğŸš¨ VIOLATED: Core should be Rust
    %% 
    %% TECHNICAL SPECIFICATIONS:
    %% â€¢ guide/reference/three-stage-pipeline.md - Pipeline flow, conflict resolution
    %% â€¢ guide/reference/confidence-system.md - Scoring algorithms, thresholds
    %% â€¢ guide/reference/lm.md - Language model integration, dual-context
    %% â€¢ guide/reference/active-region-design.md - Caret safety, span management
    %% â€¢ adr/0002-caret-safe-diff.md - Diff safety guarantees
    %% 
    %% TESTING & VALIDATION:
    %% â€¢ qa/acceptance/ - BDD scenarios for user-facing behavior
    %% â€¢ tests/ - Unit tests, integration tests, 95.11% coverage
    %% â€¢ e2e/ - Playwright end-to-end browser testing
    %% 
    %% DUAL ARCHITECTURE EXPLANATION:
    %% ğŸŸ¢ TYPESCRIPT (CURRENT): Fully functional, production-ready implementation
    %% ğŸ”´ RUST (TARGET): Partial stubs, migration target per ADR-0005
    %% ğŸ¯ WHY BOTH: TS provides immediate functionality while Rust enables cross-platform
    %% 
    %% MIGRATION PATH:
    %% 1. Complete Rust core implementation (engine.rs, confidence.rs, tapestry.rs)
    %% 2. Wire Rust FFI/WASM bindings to replace TS orchestration
    %% 3. Keep TS transformers (engines/) and UI components unchanged
    %% 4. Test cross-platform compatibility (web WASM + macOS FFI)
    %% 
    %% BUGS IDENTIFIED:
    %% ğŸš¨ ADR-0005 VIOLATION: Core orchestrator should be Rust, currently TypeScript
    %% ğŸš¨ Pipeline flow bypasses proper ConflictResolver â†’ DiffusionController flow
    %% ğŸš¨ Rust implementation incomplete - only stubs exist, no functional core
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
